version: '3.8'
services:
  hot-shard1:
    image: "redis:latest"
    container_name: hot-shard1
    ports:
      - "6380:6379"
  # hot-shard2:
  #   image: "redis:latest"
  #   container_name: hot-shard2
  #   ports:
  #     - "6381:6379"
  timeseries:
    image: "lragji/ts-v2.0"
    container_name: timeseries
    environment:
      - hot=redis://hot-shard1:6379/
      - cold=/raw-db/
      - mode=FILE
    depends_on: 
      - "hot-shard1"
      # - "hot-shard2"
    ports:
      - "80:3000"
    volumes:
      - ./raw-db/:/usr/src/app/examples/wrap-it-into-microservice/raw-db/
  jmeter:
    image: "justb4/jmeter:latest"
    container_name: jmeter
    depends_on: 
      - "timeseries"
    volumes:
      - ./:/app
    working_dir: /app
    entrypoint:
      - "/entrypoint.sh" 
      - "-n" 
      - "-t /app/PerfTest.jmx"
      - "-l /app/jmeter.jtl"
      - "-j /app/jmeter.log"
      - "-f" 
      - "-e" 
      - "-o /app/results"
      - "-JTARGET_HOST=timeseries"
      - "-JTARGET_PORT=3000"
  # cold-shard1:
  #   image: postgres:11.4
  #   restart: always
  #   environment:
  #     - POSTGRES_USER=userxyz
  #     - POSTGRES_PASSWORD=password123
  #     - POSTGRES_DB=mydb1
  #   ports:
  #     - "5434:5432"